name: scala-utils testing

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - run: date +%F > todays-date

    - name: Restore cache for today's nightly.
      uses: actions/cache@v2
      with:
        path: _neovim
        key: ${{ runner.os }}-x64-${{ hashFiles('todays-date') }}

    - name: Prepare plenary
      run: |
        git clone --depth 1 https://github.com/nvim-lua/plenary.nvim ~/.local/share/nvim/site/pack/vendor/start/plenary.nvim
        ln -s $(pwd) ~/.local/share/nvim/site/pack/vendor/start

    - name: Prepare coursier
      run: |
         curl -fLo cs https://git.io/coursier-cli-"$(uname | tr LD ld)"
         chmod +x cs
         ./cs install cs
         rm cs

    - name: Test
      run: |
        curl -OL https://raw.githubusercontent.com/norcalli/bot-ci/master/scripts/github-actions-setup.sh
        source github-actions-setup.sh nightly-x64
        export PATH="$PATH:/home/runner/.local/share/coursier/bin"
        make test
